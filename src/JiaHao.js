function t(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var e=class{constructor(t={},e=null){this.record=t,this.parent=e}define(t,e){return this.record[t]=e,e}assign(t,e){return this.resolve(t).record[t]=e}lookup(t){return this.resolve(t).record[t]}resolve(t){if(this.record.hasOwnProperty(t))return this;if(null==this.parent)throw new ReferenceError(`Variable "${t}" is not defined.`);return this.parent.resolve(t)}};var n=class{transformDefToLambda(t){const[e,n,r,s]=t;return["var",n,["lambda",r,s]]}transformSwitchToIf(t){const[e,...n]=t,r=["if",null,null,null];let s=r;for(let t=0;t<n.length-1;t++){const[e,r]=n[t];s[1]=e,s[2]=r;const i=n[t+1],[o,l]=i;s[3]="else"===o?l:["if"],s=s[3]}return r}};let r,s,i={};const o=[[-1,1,t=>{s=t}],[0,1,t=>{s=t}],[0,1,t=>{s=t}],[1,1,t=>{s=Number(t)}],[1,1,t=>{s=t}],[1,1,t=>{s=t}],[2,3,(t,e,n)=>{s=e}],[3,2,(t,e)=>{t.push(e),s=t}],[3,0,()=>{s=[]}]],l={NUMBER:"4",STRING:"5",SYMBOL:"6","'('":"7","')'":"8",$:"9"},u=[{0:1,1:2,2:3,4:"s4",5:"s5",6:"s6",7:"s7"},{9:"acc"},{4:"r1",5:"r1",6:"r1",7:"r1",8:"r1",9:"r1"},{4:"r2",5:"r2",6:"r2",7:"r2",8:"r2",9:"r2"},{4:"r3",5:"r3",6:"r3",7:"r3",8:"r3",9:"r3"},{4:"r4",5:"r4",6:"r4",7:"r4",8:"r4",9:"r4"},{4:"r5",5:"r5",6:"r5",7:"r5",8:"r5",9:"r5"},{3:8,4:"r8",5:"r8",6:"r8",7:"r8",8:"r8"},{0:10,1:2,2:3,4:"s4",5:"s5",6:"s6",7:"s7",8:"s9"},{4:"r6",5:"r6",6:"r6",7:"r6",8:"r6",9:"r6"},{4:"r7",5:"r7",6:"r7",7:"r7",8:"r7"}],a=[];let h;const c=[[/^\(/,function(){return"'('"}],[/^\)/,function(){return"')'"}],[/^\s+/,function(){}],[/^"[^\"]*"/,function(){return"STRING"}],[/^\d+/,function(){return"NUMBER"}],[/^[\w\+\-*<>=/]+/,function(){return"SYMBOL"}]],f={INITIAL:[0,1,2,3,4,5]},_={type:"$",value:""};h={initString(t){return this._string=t,this._cursor=0,this._states=["INITIAL"],this._tokensQueue=[],this._currentLine=1,this._currentColumn=0,this._currentLineBeginOffset=0,this._tokenStartOffset=0,this._tokenEndOffset=0,this._tokenStartLine=1,this._tokenEndLine=1,this._tokenStartColumn=0,this._tokenEndColumn=0,this},getStates(){return this._states},getCurrentState(){return this._states[this._states.length-1]},pushState(t){this._states.push(t)},begin(t){this.pushState(t)},popState(){return this._states.length>1?this._states.pop():this._states[0]},getNextToken(){if(this._tokensQueue.length>0)return this.onToken(this._toToken(this._tokensQueue.shift()));if(!this.hasMoreTokens())return this.onToken(_);let t=this._string.slice(this._cursor),e=f[this.getCurrentState()];for(let n=0;n<e.length;n++){let s=e[n],i=c[s],o=this._match(t,i[0]);if(""===t&&""===o&&this._cursor++,null!==o){r=o,r.length;let t=i[1].call(this);if(!t)return this.getNextToken();if(Array.isArray(t)){const e=t.slice(1);t=t[0],e.length>0&&this._tokensQueue.unshift(...e)}return this.onToken(this._toToken(t,r))}}if(this.isEOF())return this._cursor++,_;this.throwUnexpectedToken(t[0],this._currentLine,this._currentColumn)},throwUnexpectedToken(t,e,n){const r=this._string.split("\n")[e-1];let s="";if(r){s="\n\n"+r+"\n"+" ".repeat(n)+"^\n"}throw new SyntaxError(`${s}Unexpected token: "${t}" at ${e}:${n}.`)},getCursor(){return this._cursor},getCurrentLine(){return this._currentLine},getCurrentColumn(){return this._currentColumn},_captureLocation(t){const e=/\n/g;let n;for(this._tokenStartOffset=this._cursor,this._tokenStartLine=this._currentLine,this._tokenStartColumn=this._tokenStartOffset-this._currentLineBeginOffset;null!==(n=e.exec(t));)this._currentLine++,this._currentLineBeginOffset=this._tokenStartOffset+n.index+1;this._tokenEndOffset=this._cursor+t.length,this._tokenEndLine=this._currentLine,this._tokenEndColumn=this._currentColumn=this._tokenEndOffset-this._currentLineBeginOffset},_toToken(t,e=""){return{type:t,value:e,startOffset:this._tokenStartOffset,endOffset:this._tokenEndOffset,startLine:this._tokenStartLine,endLine:this._tokenEndLine,startColumn:this._tokenStartColumn,endColumn:this._tokenEndColumn}},isEOF(){return this._cursor===this._string.length},hasMoreTokens(){return this._cursor<=this._string.length},_match(t,e){let n=t.match(e);return n?(this._captureLocation(n[0]),this._cursor+=n[0].length,n[0]):null},onToken:t=>t},i.lexer=h,i.tokenizer=h,i.options={captureLocations:!1};const p={setOptions(t){return i.options=t,this},getOptions:()=>i.options,parse(t,e){if(!h)throw new Error("Tokenizer instance wasn't specified.");h.initString(t);let n=i.options;e&&(i.options=Object.assign({},i.options,e)),p.onParseBegin(t,h,i.options),a.length=0,a.push(0);let c=h.getNextToken(),f=null;do{c||(i.options=n,g());let t=a[a.length-1],e=l[c.type];u[t].hasOwnProperty(e)||(i.options=n,d(c));let _=u[t][e];if("s"===_[0]){let t=null;i.options.captureLocations&&(t={startOffset:c.startOffset,endOffset:c.endOffset,startLine:c.startLine,endLine:c.endLine,startColumn:c.startColumn,endColumn:c.endColumn}),f=this.onShift(c),a.push({symbol:l[f.type],semanticValue:f.value,loc:t},Number(_.slice(1))),c=h.getNextToken()}else if("r"===_[0]){let t=_.slice(1),e=o[t],n="function"==typeof e[2],l=n?[]:null;const h=n&&i.options.captureLocations?[]:null;if(0!==e[1]){let t=e[1];for(;t-- >0;){a.pop();let t=a.pop();n&&(l.unshift(t.semanticValue),h&&h.unshift(t.loc))}}const c={symbol:e[0]};if(n){r=f?f.value:null,f&&f.value.length;const t=null!==h?l.concat(h):l;e[2](...t),c.semanticValue=s,h&&(c.loc=undefined)}const p=a[a.length-1],d=e[0];a.push(c,u[p][d])}else if("acc"===_){a.pop();let t=a.pop();return(1!==a.length||0!==a[0]||h.hasMoreTokens())&&(i.options=n,d(c)),t.hasOwnProperty("semanticValue")?(i.options=n,p.onParseEnd(t.semanticValue),t.semanticValue):(p.onParseEnd(),i.options=n,!0)}}while(h.hasMoreTokens()||a.length>1)},setTokenizer:t=>(h=t,p),getTokenizer:()=>h,onParseBegin(t,e,n){},onParseEnd(t){},onShift:t=>t};function d(t){"$"===t.type&&g(),h.throwUnexpectedToken(t.value,t.startLine,t.startColumn)}function g(){!function(t){throw new SyntaxError(t)}("Unexpected end of input.")}const k=e,m=n,v=p;const L=new k({null:null,true:!0,false:!1,VERSION:"0.1","+":(t,e)=>t+e,"*":(t,e)=>t*e,"-":(t,e=null)=>null==e?-t:t-e,"/":(t,e)=>t/e,">":(t,e)=>t>e,"<":(t,e)=>t<e,">=":(t,e)=>t>=e,"<=":(t,e)=>t<=e,"=":(t,e)=>t===e,print(...t){console.log(...t)}});var O=t(class{constructor(t=L){this.global=t,this._transformer=new m}evalParse(t){const e=v.parse(`(begin ${t})`);return this.evalGlobal(e)}evalGlobal(t){return this._evalBody(t,this.global)}eval(t,e=this.global){if(this._isNumber(t))return t;if(this._isString(t))return t.slice(1,-1);if(this._isVariableName(t))return e.lookup(t);if("var"===t[0]){const[n,r,s]=t;return e.define(r,this.eval(s,e))}if("begin"===t[0]){const n=new k({},e);return this._evalBlock(t,n)}if("set"===t[0]){const[n,r,s]=t;if("prop"===r[0]){const[t,n,i]=r;return this.eval(n,e).define(i,this.eval(s,e))}return e.assign(r,this.eval(s,e))}if("if"===t[0]){const[n,r,s,i]=t;return this.eval(r,e)?this.eval(s,e):this.eval(i,e)}if("while"===t[0]){const[n,r,s]=t;let i;for(;this.eval(r,e);)i=this.eval(s,e);return i}if("def"===t[0]){const n=this._transformer.transformDefToLambda(t);return this.eval(n,e)}if("switch"===t[0]){const n=this._transformer.transformSwitchToIf(t);return this.eval(n,e)}if("lambda"===t[0]){const[n,r,s]=t;return{params:r,body:s,env:e}}if("class"===t[0]){const[n,r,s,i]=t,o=this.eval(s,e)||e,l=new k({},o);return this._evalBody(i,l),e.define(r,l)}if("super"===t[0]){const[n,r]=t;return this.eval(r,e).parent}if("new"===t[0]){const n=this.eval(t[1],e),r=new k({},n),s=t.slice(2).map((t=>this.eval(t,e)));return this._callUserDefinedFunction(n.lookup("constructor"),[r,...s]),r}if("prop"===t[0]){const[n,r,s]=t;return this.eval(r,e).lookup(s)}if("module"===t[0]){const[n,r,s]=t,i=new k({},e);return this._evalBody(s,i),e.define(r,i)}if(Array.isArray(t)){const n=this.eval(t[0],e),r=t.slice(1).map((t=>this.eval(t,e)));return"function"==typeof n?n(...r):this._callUserDefinedFunction(n,r)}throw`Unimplemented: ${JSON.stringify(t)}`}_callUserDefinedFunction(t,e){const n={};t.params.forEach(((t,r)=>{n[t]=e[r]}));const r=new k(n,t.env);return this._evalBody(t.body,r)}_evalBody(t,e){return"begin"===t[0]?this._evalBlock(t,e):this.eval(t,e)}_evalBlock(t,e){let n;const[r,...s]=t;return s.forEach((t=>{n=this.eval(t,e)})),n}_isNumber(t){return"number"==typeof t}_isString(t){return"string"==typeof t&&'"'===t[0]&&'"'===t.slice(-1)}_isVariableName(t){return"string"==typeof t&&/^[+\-*/<>=a-zA-Z0-9_]*$/.test(t)}});export{O as default};
